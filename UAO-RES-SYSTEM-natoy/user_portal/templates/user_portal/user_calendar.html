<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Calendar</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'user_portal/styles.css' %}">

    <!-- FullCalendar 5.11.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

    <style>
        .calendar-container {
            width: 80%;
            margin: 0 auto;
            text-align: center;
        }

        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
            z-index: 1000;
            max-width: 300px;
            word-wrap: break-word;
        }

        #calendar {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header>
        <div class="logo">
            <img src="{% static 'user_portal/xavier_logo.png' %}" alt="XU Logo" class="xu-logo">
            <h1>Xavier University Athletics Office</h1>
        </div>

        <div class="right-nav">
            <a href="{% url 'user_portal:user_dashboard' %}">Dashboard</a>
            <a href="{% url 'user_portal:user_myreservation' %}">My Reservations</a>
            <a href="{% url 'user_portal:user_makereservation' %}">Make Reservation</a>
            <a href="{% url 'user_portal:user_calendar' %}">View Calendar</a>
            <a href="{% url 'user_portal:user_profile' %}">Profile</a>
        </div>
    </header>

    <!-- Calendar Section -->
    <div class="calendar-container">
        <h1>User Calendar</h1>
        <div id="calendar"></div>
        <div id="tooltip" class="tooltip"></div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

    <script>
            document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const tooltip = document.getElementById('tooltip');
        
        let calendar; // Define calendar in outer scope
        
        // Function to refresh calendar data
        function refreshCalendar() {
            if (calendar) {
                calendar.refetchEvents();
                console.log('Calendar events refreshed');
            }
        }
        
        // Create the calendar
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 'auto',
            events: function(info, successCallback, failureCallback) {
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                
                $.ajax({
                    url: `{% url 'user_portal:get_reservations' %}?_=${timestamp}`,
                    type: 'GET',
                    dataType: 'json',
                    cache: false, // Disable caching
                    success: function(data) {
                        console.log('Events Data received:', data.length, 'events');
                        console.log('First few events:', data.slice(0, 3));
                        
                        // Format the events for the calendar
                        const events = data.map(event => {
                            const eventObject = {
                                title: event.title,
                                start: event.start,
                                end: event.end,
                                extendedProps: {
                                    event_type: event.event_type,
                                    user_name: event.user_name,
                                    organization: event.organization,
                                    reason: event.reason
                                }
                            };
                            
                            // Add visual distinction for blocked dates
                            if (event.reason) {
                                eventObject.backgroundColor = '#FF6B6B'; // Red color for blocked dates
                                eventObject.borderColor = '#FF6B6B';
                                eventObject.textColor = '#FFFFFF';
                            }
                            
                            return eventObject;
                        });
                        
                        successCallback(events);
                    },
                    error: function(err) {
                        console.error('Error loading events:', err);
                        failureCallback(err);
                    }
                });
            },
            eventDisplay: 'block',
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: true },
            eventMouseEnter: function(info) {
                const props = info.event.extendedProps;

                let tooltipContent = `<strong>${info.event.title}</strong><br>`;
                tooltipContent += `<strong>Date:</strong> ${info.event.start.toLocaleDateString()}<br>`;

                if (props.reason) {
                    tooltipContent += `<strong>Reason:</strong> ${props.reason}`;
                } else {
                    tooltipContent += `<strong>Time:</strong> ${info.event.start.toLocaleTimeString()} - ${info.event.end ? info.event.end.toLocaleTimeString() : "TBD"}<br>`;
                    tooltipContent += `<strong>Event Type:</strong> ${props.event_type || 'N/A'}<br>`;
                    tooltipContent += `<strong>Reserved By:</strong> ${props.user_name || 'Unknown'}<br>`;
                    tooltipContent += `<strong>Organization:</strong> ${props.organization || 'Unknown'}`;
                }

                tooltip.innerHTML = tooltipContent;
                tooltip.style.display = "block";
                tooltip.style.left = (info.jsEvent.pageX + 10) + "px";
                tooltip.style.top = (info.jsEvent.pageY + 10) + "px";
            },
            eventMouseLeave: function () {
                tooltip.style.display = "none";
            },
            eventMouseMove: function (info) {
                tooltip.style.left = (info.jsEvent.pageX + 15) + "px";
                tooltip.style.top = (info.jsEvent.pageY + 15) + "px";
            },
            eventClick: function (info) {
                const p = info.event.extendedProps;
                if (p.reason) {
                    alert(`Blocked Date:\n\n${info.event.title}\nReason: ${p.reason}`);
                } else {
                    const details = `
    Reservation Details:
    --------------------
    Facility: ${info.event.title}
    Date: ${info.event.start.toLocaleDateString()}
    Time: ${info.event.start.toLocaleTimeString()} - ${info.event.end ? info.event.end.toLocaleTimeString() : "TBD"}
    Event Type: ${p.event_type || 'N/A'}
    Reserved By: ${p.user_name || 'Unknown'}
    Organization: ${p.organization || 'Unknown'}
                    `;
                    alert(details);
                }
            }
        });

        calendar.render();
        
        // Add refresh button to manually refresh the calendar
        const calendarContainer = document.querySelector('.calendar-container');
        if (calendarContainer) {
            const refreshButton = document.createElement('button');
            refreshButton.textContent = 'Refresh Calendar';
            refreshButton.classList.add('refresh-button');
            refreshButton.style.marginTop = '15px';
            refreshButton.style.padding = '8px 16px';
            refreshButton.style.backgroundColor = '#4CAF50';
            refreshButton.style.color = 'white';
            refreshButton.style.border = 'none';
            refreshButton.style.borderRadius = '4px';
            refreshButton.style.cursor = 'pointer';
            
            refreshButton.addEventListener('click', refreshCalendar);
            
            calendarContainer.appendChild(refreshButton);
        }
        
        // Auto-refresh calendar every 60 seconds
        setInterval(refreshCalendar, 60000);
    });
    </script>
</body>
</html>
