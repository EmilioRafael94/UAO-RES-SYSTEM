{% extends 'base.html' %}
{% load static %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'user_portal/styles.css' %}">
    <style>
        #blocked-date-message {
            color: #dc3545;
            font-weight: bold;
            margin-top: 5px;
            display: none;
        }
        #fully-blocked-date-message {
            color: #dc3545;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>
 

    <main class="user_makereservation-container">
        <h2>Reservation for the Use of the University Sports Facilities</h2>
        <form method="POST" id="reservationForm">
            {% csrf_token %}

            <!-- Organization Information -->
            <div class="make_reservation-form-group">
                <label for="organization">Name of Unit/School/Office/Organization</label>
                <input type="text" id="organization" name="organization" placeholder="e.g., School of Business and Management">
            </div>

            <div class="make_reservation-form-group">
                <label for="representative">Name of Representative</label>
                <input type="text" id="representative" name="representative" required>
            </div>

            <div class="make_reservation-form-group">
                <label for="contact_number">Contact No.</label>
                <input type="tel" id="contact_number" name="contact_number" pattern="[0-9]{10,11}" placeholder="e.g., 09123456789" required>
            </div>

            <!-- Reservation Information -->
            <div class="make_reservation-form-group">
                <label for="date_reserved">Date Reserved</label>
                <input type="date" id="date_reserved" name="date_reserved" required>
            </div>

            <div class="make_reservation-form-group">
                <label for="insider_count">Estimated No. of Participants (Insider)</label>
                <input type="number" id="insider_count" name="insider_count" min="0">
            </div>

            <div class="make_reservation-form-group">
                <label for="outsider_count">Estimated No. of Participants (Outsider)</label>
                <input type="number" id="outsider_count" name="outsider_count" min="0">
            </div>

            <div class="make_reservation-form-group">
                <label for="date">Date of Actual Use</label>
                <input type="date" id="date" name="date" required>
                <div id="blocked-date-message"></div>
                <div id="fully-blocked-date-message"></div>
            </div>

            <div class="make_reservation-form-group">
                <label for="start_time">Start Time</label>
                <input type="time" name="start_time" id="start_time" required>
            </div>
            
            <div class="make_reservation-form-group">
                <label for="end_time">End Time</label>
                <input type="time" name="end_time" id="end_time" required>
            </div>

            <!-- Facilities -->
            <div class="make_reservation-form-group">
                <label>Facilities to be used</label>
                <div class="make_reservation-checkbox-group">
                    <label><input type="checkbox" name="facilities_needed" value="Gymnasium"> Gymnasium</label>
                    <label><input type="checkbox" name="facilities_needed"  value="Covered Court"> Covered Court</label>
                    <label><input type="checkbox" name="facilities_needed" value="Football Field"> Football Field</label>
                    <label><input type="checkbox" name="facilities_needed" value="Table Tennis Dug-out"> Table Tennis Dug-out</label>
                </div>
            </div>
          
 

            <!-- Event Type -->
            <div class="make_reservation-form-group">
                <label>Type of Event</label>
                <div class="make_reservation-checkbox-group">
                    <label><input type="checkbox" name="event_type" value="Sports Activities"> Sports-Related Activities</label>
                    <label><input type="checkbox" name="event_type" value="General Assembly"> General Assembly</label>
                    <label><input type="checkbox" name="event_type" value="Forum"> Forum/Symposium</label>
                    <label><input type="checkbox" name="event_type" value="Others"> Others</label>
                </div>
            </div>

            <!-- Other Facilities -->
            <div class="make_reservation-form-group">
                <label>Other Facilities Needed (Indicate Quantity)</label>
                <div class="make_reservation-facilities-grid">
                    <!-- Tables 1â€“4 -->
                    <table>
                        <tr><td>Long Tables</td><td><input type="number" name="long_tables_quantity" min="0"></td></tr>
                        <tr><td>Mono Block Chairs</td><td><input type="number" name="mono_block_chairs_quantity" min="0"></td></tr>
                        <tr><td>Narra Chairs</td><td><input type="number" name="narra_chairs_quantity" min="0"></td></tr>
                        <tr><td>Podium</td><td><input type="number" name="podium_quantity" min="0"></td></tr>
                        <tr><td>XU Seal</td><td><input type="number" name="xu_seal_quantity" min="0"></td></tr>
                        <tr><td>XU Logo</td><td><input type="number" name="xu_logo_quantity" min="0"></td></tr>
                    </table>
                    <table>
                        <tr><td>Sound System</td><td><input type="number" name="sound_system_quantity" min="0"></td></tr>
                        <tr><td>Bulletin Board</td><td><input type="number" name="bulletin_board_quantity" min="0"></td></tr>
                        <tr><td>Scaffolding</td><td><input type="number" name="scaffolding_quantity" min="0"></td></tr>
                        <tr><td>Flag</td><td><input type="number" name="flag_quantity" min="0"></td></tr>
                        <tr><td>Philippine Flag</td><td><input type="number" name="philippine_flag_quantity" min="0"></td></tr>
                        <tr><td>XU Flag</td><td><input type="number" name="xu_flag_quantity" min="0"></td></tr>
                    </table>
                    <table>
                        <tr><td>Ceiling Fans</td><td><input type="number" name="ceiling_fans_quantity" min="0"></td></tr>
                        <tr><td>Stand Fans</td><td><input type="number" name="stand_fans_quantity" min="0"></td></tr>
                        <tr><td>Iwata Fans</td><td><input type="number" name="iwata_fans_quantity" min="0"></td></tr>
                        <tr><td>Stage Non-Acrylic</td><td><input type="number" name="stage_non_acrylic_quantity" min="0"></td></tr>
                    </table>
                    <table>
                        <tr><td>Digital Clock</td><td><input type="number" name="digital_clock_quantity" min="0"></td></tr>
                    </table>
                    <table>
                        <tr><td>Others (Please specify)</td><td><input type="text" name="others_specify"></td></tr>
                    </table>
                </div>
            </div>

            <!-- Manpower Needed -->
            <div class="make_reservation-form-group">
                <label>Manpower Needed</label>
                <div class="make_reservation-table-container">
                    <table>
                        <tr><td>Security</td><td><input type="number" name="security_quantity" min="0"></td></tr>
                        <tr><td>Janitor</td><td><input type="number" name="janitor_quantity" min="0"></td></tr>
                    </table>
                    <table>
                        <tr><td>Electrician</td><td><input type="number" name="electrician_quantity" min="0"></td></tr>
                        <tr><td>Technician</td><td><input type="number" name="technician_quantity" min="0"></td></tr>
                    </table>
                    <table>
                        <tr><td>Assistant Technician</td><td><input type="number" name="assistant_technician_quantity" min="0"></td></tr>
                        <tr><td>Digital Clock Operator</td><td><input type="number" name="digital_clock_operator_quantity" min="0"></td></tr>
                    </table>
                    <table>
                        <tr><td>Plumber</td><td><input type="number" name="plumber_quantity" min="0"></td></tr>
                        <tr><td>Other:</td><td><input type="number" name="other_manpower_quantity" min="0"></td></tr>
                    </table>
                </div>
            </div>
            

            <div class="make_reservation-form-group">
                <input type="submit" value="Submit" id="submitBtn">
            </div>
        </form>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    $(document).ready(function() {
        let blockedEvents = [];
        // Fetch all blocked events (date, time, facility)
        $.ajax({
            url: '/user_portal/get_blocked_dates_json/',
            method: 'GET',
            success: function(data) {
                blockedEvents = data;
            }
        });
        function isBlocked(selected, start, end, facilities) {
            if (!selected || !start || !end || !facilities.length) return false;
            for (let event of blockedEvents) {
                // Check if selected date is within block range
                if (selected >= event.date && selected <= event.end_date) {
                    for (let f of facilities) {
                        if (event.facility === f) {
                            // Check if selected time overlaps with block
                            if (!(end <= event.start_time || start >= event.end_time)) {
                                return event.reason || 'Blocked';
                            }
                        }
                    }
                }
            }
            return false;
        }
        function isDateFullyBlocked(selected) {
            // Returns reason if the date is fully blocked for any facility (start_time=00:00, end_time=23:59)
            for (let event of blockedEvents) {
                if (selected >= event.date && selected <= event.end_date) {
                    if (event.start_time === '00:00' && (event.end_time === '23:59' || event.end_time === '24:00')) {
                        return event.reason || 'This date is blocked';
                    }
                }
            }
            return false;
        }
        function checkBlocked() {
            let selected = $('#date').val();
            let start = $('#start_time').val();
            let end = $('#end_time').val();
            let facilities = [];
            $('input[name="facilities_needed"]:checked').each(function() {
                facilities.push($(this).val());
            });
            // Early prompt for fully blocked date
            let fullReason = isDateFullyBlocked(selected);
            if (fullReason) {
                let dateText = selected ? new Date(selected).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) : 'This date';
                $('#fully-blocked-date-message').text(dateText + ' is blocked. Reason: ' + fullReason).show();
            } else {
                $('#fully-blocked-date-message').hide();
            }
            // Usual block check for time/facility
            let reason = isBlocked(selected, start, end, facilities);
            if (reason) {
                $('#blocked-date-message').text('This date/time is blocked. Reason: ' + reason).show();
                $('#submitBtn').prop('disabled', true);
            } else {
                $('#blocked-date-message').hide();
                $('#submitBtn').prop('disabled', false);
            }
        }
        $('#date, #start_time, #end_time').on('change', checkBlocked);
        $('input[name="facilities_needed"]').on('change', checkBlocked);
        $('#reservationForm').on('submit', function(e) {
            let selected = $('#date').val();
            let start = $('#start_time').val();
            let end = $('#end_time').val();
            let facilities = [];
            $('input[name="facilities_needed"]:checked').each(function() {
                facilities.push($(this).val());
            });
            let reason = isBlocked(selected, start, end, facilities);
            if (reason) {
                $('#blocked-date-message').text('This date/time is blocked. Reason: ' + reason).show();
                $('#submitBtn').prop('disabled', true);
                e.preventDefault();
                return false;
            }
        });
        // Also check on page load in case of pre-filled date
        checkBlocked();
    });
    </script>
</body>
</html>
{% endblock %}
