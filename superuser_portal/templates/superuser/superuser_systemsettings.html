{% extends 'superuser/base_superuser.html' %}

{% block title %}System Settings{% endblock %}

{% block content %}
    <div class="settings-container">
        <!-- Facility Management -->
        <div class="settings-section">
            <h2>Facility Management</h2>
            <div class="facility-list">
                {% for facility in facilities %}
                <div class="facility-item">
                    <div class="facility-info">
                        <h3 class="facility-name">{{ facility.name }}</h3>
                        <div class="facility-details">
                            <span class="facility-capacity"><i class="fas fa-users"></i> Capacity: {{ facility.capacity }}</span>
                            {% if facility.description %}
                            <p class="facility-description">{{ facility.description }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="facility-actions">
                        <button onclick="editFacility('{{ facility.id }}')" class="edit-btn"><i class="fas fa-edit"></i> Edit</button>
                        <button onclick="deleteFacility('{{ facility.id }}')" class="delete-btn"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <p>No facilities added yet</p>
                </div>
                {% endfor %}
            </div>
            <button onclick="showAddFacilityModal()" class="add-btn"><i class="fas fa-plus"></i> Add New Facility</button>
        </div>

        <!-- Time Slot Templates -->
        <div class="settings-section">
            <h2>Time Slot Templates</h2>
            <div class="time-slots-grid">
                {% for template in time_templates %}
                <div class="time-slot-template">
                    <div class="template-header">
                        <h3>{{ template.name }}</h3>
                        <div class="template-actions">
                            <button onclick="editTemplate('{{ template.id }}')" class="edit-btn"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteTemplate('{{ template.id }}')" class="delete-btn"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="slot-times">
                        {% for slot in template.slots.all %}
                        <div class="slot">
                            <i class="far fa-clock"></i>
                            <span>{{ slot.start_time|time:"g:i A" }} - {{ slot.end_time|time:"g:i A" }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <p>No time slot templates added yet</p>
                </div>
                {% endfor %}
            </div>
            <button onclick="showAddTemplateModal()" class="add-btn"><i class="fas fa-plus"></i> Add New Template</button>
        </div>

        <!-- Blocked Dates -->
        <div class="settings-section">
            <h2>Blocked Dates</h2>
            <div class="blocked-dates-list">
                {% for blocked_date in blocked_dates %}
                <div class="blocked-date-item">
                    <div class="blocked-date-info">
                        <h4>{{ blocked_date.facility.name }}</h4>
                        <div class="date-range">
                            <i class="far fa-calendar-alt"></i>
                            <span>{{ blocked_date.start_date|date:"M d, Y" }} - {{ blocked_date.end_date|date:"M d, Y" }}</span>
                        </div>
                        {% if blocked_date.reason %}
                        <p class="blocked-reason">{{ blocked_date.reason }}</p>
                        {% endif %}
                    </div>
                    <div class="blocked-date-actions">
                        <button onclick="deleteBlockedDate('{{ blocked_date.id }}')" class="delete-btn"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <p>No dates are currently blocked</p>
                </div>
                {% endfor %}
            </div>
            <button onclick="showBlockDateModal()" class="add-btn"><i class="fas fa-plus"></i> Block New Date</button>
        </div>
    </div>
{% endblock %}

{% block modal %}
    <!-- Add Facility Modal -->
    <div id="facilityModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add/Edit Facility</h2>
            <form id="facilityForm" method="POST" action="{% url 'superuser_portal:manage_facility' %}">
                {% csrf_token %}
                <input type="hidden" id="facilityId" name="facility_id">
                <div class="form-group">
                    <label for="facilityName">Facility Name:</label>
                    <input type="text" id="facilityName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="facilityCapacity">Capacity:</label>
                    <input type="number" id="facilityCapacity" name="capacity" required>
                </div>
                <div class="form-group">
                    <label for="facilityDescription">Description:</label>
                    <textarea id="facilityDescription" name="description"></textarea>
                </div>
                <button type="submit" class="save-btn">Save</button>
            </form>
        </div>
    </div>

    <!-- Add Time Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add/Edit Time Template</h2>
            <form id="templateForm" method="POST" action="{% url 'superuser_portal:add_time_template' %}">
                {% csrf_token %}
                <input type="hidden" id="templateId" name="template_id">
                <div class="form-group">
                    <label for="templateName">Template Name:</label>
                    <input type="text" id="templateName" name="name" required>
                </div>
                <div id="timeSlots">
                    <div class="time-slot-input">
                        <input type="time" name="start_time[]" required>
                        <input type="time" name="end_time[]" required>
                        <button type="button" class="remove-slot">Remove</button>
                    </div>
                </div>
                <button type="button" onclick="addTimeSlot()" class="add-slot-btn">Add Time Slot</button>
                <button type="submit" class="save-btn">Save Template</button>
            </form>
        </div>
    </div>

    <!-- Block Date Modal -->
    <div id="blockDateModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Block Date</h2>
            <form id="blockDateForm" method="POST" action="{% url 'superuser_portal:manage_blocked_dates' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="facility">Select Facility:</label>
                    <select id="facility" name="facility" required>
                        {% for facility in facilities %}
                            <option value="{{ facility.id }}">{{ facility.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="blockStartDate">Start Date:</label>
                    <input type="date" id="blockStartDate" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="blockEndDate">End Date:</label>
                    <input type="date" id="blockEndDate" name="end_date" required>
                </div>
                <div class="form-group">
                    <label for="blockReason">Reason:</label>
                    <textarea id="blockReason" name="reason" required></textarea>
                </div>
                <button type="submit" class="save-btn">Block Dates</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Modal Management
    function showModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function hideModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Facility Management
    function showAddFacilityModal() {
        // Reset the form action to the add URL
        const form = document.getElementById('facilityForm');
        form.action = "{% url 'superuser_portal:manage_facility' %}";
        document.getElementById('facilityId').value = '';
        document.getElementById('facilityName').value = '';
        document.getElementById('facilityCapacity').value = '';
        document.getElementById('facilityDescription').value = '';
        showModal('facilityModal');
    }

    function editFacility(id) {
        document.getElementById('facilityId').value = id;
        const form = document.getElementById('facilityForm');
        form.action = `/superuser_portal/facility/${id}/`;
        // Load facility data and show modal
        fetch(`/superuser_portal/facility/${id}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('facilityName').value = data.name;
                document.getElementById('facilityCapacity').value = data.capacity;
                document.getElementById('facilityDescription').value = data.description || '';
                showModal('facilityModal');
            });
    }

    function deleteFacility(id) {
        if (confirm('Are you sure you want to delete this facility?')) {
            fetch('/superuser_portal/facility/' + id + '/delete/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            }).then(() => window.location.reload());
        }
    }

    // Time Template Management
    function showAddTemplateModal() {
        const form = document.getElementById('templateForm');
        form.action = "{% url 'superuser_portal:add_time_template' %}";
        document.getElementById('templateId').value = '';
        document.getElementById('templateName').value = '';
        const timeSlots = document.getElementById('timeSlots');
        timeSlots.innerHTML = `
            <div class="time-slot-input">
                <input type="time" name="start_time[]" required>
                <input type="time" name="end_time[]" required>
                <button type="button" class="remove-slot" onclick="this.parentElement.remove()">Remove</button>
            </div>
        `;
        showModal('templateModal');
    }

    function editTemplate(id) {
        document.getElementById('templateId').value = id;
        const form = document.getElementById('templateForm');
        form.action = "{% url 'superuser_portal:edit_time_template' template_id=0 %}".replace('0', id);
        // Load template data and show modal
        fetch('/superuser_portal/time-template/' + id + '/edit/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('templateName').value = data.name;
                const timeSlots = document.getElementById('timeSlots');
                timeSlots.innerHTML = '';
                data.slots.forEach(slot => {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'time-slot-input';
                    slotDiv.innerHTML = `
                        <input type="time" name="start_time[]" value="${slot.start}" required>
                        <input type="time" name="end_time[]" value="${slot.end}" required>
                        <button type="button" class="remove-slot" onclick="this.parentElement.remove()">Remove</button>
                    `;
                    timeSlots.appendChild(slotDiv);
                });
                showModal('templateModal');
            });
    }

    function deleteTemplate(id) {
        if (confirm('Are you sure you want to delete this template?')) {
            fetch('/superuser_portal/time-template/' + id + '/delete/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            }).then(() => window.location.reload());
        }
    }

    function addTimeSlot() {
        const timeSlots = document.getElementById('timeSlots');
        const newSlot = document.createElement('div');
        newSlot.className = 'time-slot-input';
        newSlot.innerHTML = `
            <input type="time" name="start_time[]" required>
            <input type="time" name="end_time[]" required>
            <button type="button" class="remove-slot" onclick="this.parentElement.remove()">Remove</button>
        `;
        timeSlots.appendChild(newSlot);
    }

    // Block Date Management
    function showBlockDateModal() {
        showModal('blockDateModal');
    }

    function deleteBlockedDate(id) {
        if (confirm('Are you sure you want to delete this blocked date?')) {
            fetch('/superuser_portal/blocked-dates/' + id + '/delete/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            }).then(() => window.location.reload());
        }
    }

    // Close buttons
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.onclick = function() {
            this.closest('.modal').style.display = 'none';
        }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
</script>
{% endblock %}

