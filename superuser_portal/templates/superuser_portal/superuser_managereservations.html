{% extends 'superuser_portal/base_superuser.html' %}

{% block title %}Manage Reservations{% endblock %}

{% block content %}
    <div class="reservations-container">
        <!-- Filter Section -->
        <div class="filter-bar">
            <select id="statusFilter" onchange="applyFilter(this.value)">
                <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All Reservations</option>
                <option value="needs_billing" {% if current_filter == 'needs_billing' %}selected{% endif %}>Needs Billing</option>
                <option value="needs_payment" {% if current_filter == 'needs_payment' %}selected{% endif %}>Needs Receipt Verification</option>
                <option value="needs_pass" {% if current_filter == 'needs_pass' %}selected{% endif %}>Needs Pass Review</option>
            </select>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search reservations..." oninput="searchReservations()">
            </div>
        </div>

        <!-- Reservations Table -->
        <div class="reservations-table">
            <table>
                <thead>
                    <tr>
                        <th>Reference #</th>
                        <th>Facility</th>
                        <th>Event Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reservationsBody">
                    {% for res in reservations %}
                    <tr>
                        <td>{{ res.reference }}</td>
                        <td>{{ res.facility }}</td>
                        <td>{{ res.date|date:"M d, Y" }}</td>
                        <td>
                            {% if res.admin_rejections and res.admin_rejections|length > 0 %}
                                <span class="status-badge status-terminated">Terminated</span>
                            {% elif res.admin_approvals and res.admin_approvals|length >= 4 %}
                                <span class="status-badge status-ready">Ready for Billing</span>
                            {% else %}
                                <span class="status-badge status-waiting">Waiting for Admin Approvals</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if res.admin_rejections and res.admin_rejections|length > 0 %}
                                <button class="view-btn" disabled style="opacity:0.5;cursor:not-allowed;">Go</button>
                            {% elif res.admin_approvals and res.admin_approvals|length >= 4 %}
                                <button onclick="viewReservationDetails('{{ res.id }}')" class="view-btn">Go</button>
                            {% else %}
                                <button class="view-btn" disabled style="opacity:0.5;cursor:not-allowed;">Go</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="no-data">No reservations found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block modal %}
    <!-- Reservation Details Modal -->
    <div id="reservationModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h2>Reservation Details</h2>
            </div>
            <div class="modal-body">
                <!-- Hidden field to store current reservation ID -->
                <input type="hidden" id="current-reservation-id" value="">

                <div class="steps-container">
                    <!-- Billing Section -->
                    <div class="step-section">
                        <h3>Step 1: Billing</h3>
                        <div id="billingDetails">
                            Loading...
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div class="step-section">
                        <h3>Step 2: Payment Verification</h3>
                        <div id="paymentDetails">
                            Loading...
                        </div>
                    </div>

                    <!-- Security Pass Section -->
                    <div class="step-section">
                        <h3>Step 3: Security Pass</h3>
                        <div id="passDetails">
                            Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Pass Reject Modal -->
    <div id="rejectPassModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:400px;">
            <span class="close" onclick="closeRejectPassModal()">&times;</span>
            <h3>Reject Security Pass</h3>
            <form id="rejectPassForm">
                <input type="hidden" id="reject-pass-reservation-id">
                <div class="form-group">
                    <label for="reject-pass-reason">Reason for rejection:</label>
                    <textarea id="reject-pass-reason" class="form-control" required></textarea>
                </div>
                <button type="submit" class="btn btn-danger">Reject</button>
                <button type="button" class="btn btn-secondary" onclick="closeRejectPassModal()">Cancel</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
// --- Ensure these functions are globally available ---
function updateReservationRowStatus(reservationId, newStatus) {
    // Find the row by reservationId (assuming it's in the Reference # cell)
    const rows = document.querySelectorAll('#reservationsBody tr');
    rows.forEach(row => {
        const refCell = row.querySelector('td');
        if (refCell && refCell.textContent.trim().endsWith(reservationId.toString())) {
            // Update the status cell (4th cell, index 3)
            const statusCell = row.querySelectorAll('td')[3];
            if (statusCell) {
                statusCell.innerHTML = `<span class="status-badge status-${newStatus.toLowerCase().replace(/ /g, '-')}">${newStatus}</span>`;
            }
        }
    });
}

function verifyPayment(reservationId) {
    if (!confirm('Verify this payment?')) return;
    fetchWithToken(`/superuser_portal/verify_payment/${reservationId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'verify' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Payment verified!');
            viewReservationDetails(reservationId);
            updateReservationRowStatus(reservationId, 'Payment Approved');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred.');
    });
}

function rejectPayment(reservationId) {
    const reason = prompt('Enter reason for rejection:');
    if (!reason) return;
    fetchWithToken(`/superuser_portal/verify_payment/${reservationId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'reject', reason: reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Payment rejected.');
            viewReservationDetails(reservationId);
            updateReservationRowStatus(reservationId, 'Payment Rejected');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred.');
    });
}

// Filter functionality
function applyFilter(filterValue) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('filter', filterValue);
    window.location.href = currentUrl.toString();
}

// Search functionality
function searchReservations() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#reservationsBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchText) ? '' : 'none';
    });
}

// Modal functionality
const modal = document.getElementById('reservationModal');
const closeBtn = document.querySelector('.modal-content .close');

function viewReservationDetails(reservationId) {
    modal.style.display = 'block';
    
    // Load reservation details via Ajax
    fetch(`/superuser_portal/reservation/${reservationId}/details/`)
        .then(response => response.json())
        .then(data => {
            updateBillingSection(data.billing);
            updatePaymentSection(data.payment);
            updatePassSection(data.pass);
            document.getElementById('current-reservation-id').value = reservationId; // Set reservation ID
        });
}

function updateBillingSection(billing) {
    const billingHtml = billing.statement_url ? 
        `<div class="file-section">
            <a href="${billing.statement_url}" class="file-link" target="_blank">
                View Billing Statement
            </a>
        </div>` :
        `<div class="upload-section">
            <form onsubmit="uploadBilling(event)">
                <input type="file" required>
                <button type="submit">Upload Billing Statement</button>
            </form>
        </div>`;
    
    document.getElementById('billingDetails').innerHTML = billingHtml;
}

function updatePaymentSection(payment) {
    let paymentHtml = '';

    if (payment.receipt_url) {
        // Payment receipt has been uploaded by user
        paymentHtml = `
            <div class="receipt-section">
                <div class="receipt-preview">
                    <a href="${payment.receipt_url}" target="_blank" class="btn btn-sm btn-primary">
                        View Payment Receipt
                    </a>
                </div>
                <div class="verification-actions mt-3">
                    <button type="button" class="btn btn-success" id="verifyPaymentBtn">
                        <i class="fas fa-check-circle"></i> Verify Payment
                    </button>
                    <button type="button" class="btn btn-danger" id="rejectPaymentBtn">
                        <i class="fas fa-times-circle"></i> Reject
                    </button>
                </div>
            </div>`;
    } else {
        // No payment receipt uploaded yet
        paymentHtml = `
            <div class="waiting-message">
                Waiting for payment receipt...
            </div>`;
    }

    if (payment.status === 'Payment Rejected' && payment.rejection_reason) {
        paymentHtml += `<div class="alert alert-danger mt-2"><strong>Rejection Reason:</strong> ${payment.rejection_reason}</div>`;
    }

    document.getElementById('paymentDetails').innerHTML = paymentHtml;

    // Attach event listeners after rendering
    const verifyBtn = document.getElementById('verifyPaymentBtn');
    if (verifyBtn) {
        verifyBtn.onclick = function() { verifyPayment(payment.id); };
    }
    const rejectBtn = document.getElementById('rejectPaymentBtn');
    if (rejectBtn) {
        rejectBtn.onclick = function() { rejectPayment(payment.id); };
    }
}

function updatePassSection(pass) {
    let passHtml = '';
    // Show upload form if superuser needs to upload a blank security pass
    if ((pass.can_upload || pass.status === 'Needs Security Pass' || pass.status === 'Payment Approved') && !pass.file_url) {
        passHtml = `<form id="uploadPassForm" enctype="multipart/form-data" onsubmit="uploadSecurityPass(event)">
            <input type="file" name="security_pass" required>
            <button type="submit" class="btn btn-primary btn-sm">Upload Security Pass</button>
        </form>`;
    } else if (pass.file_url) {
        // Show the uploaded security pass file
        passHtml = `<div class="file-section">
            <a href="${pass.file_url}" class="file-link" target="_blank">View Security Pass</a>`;
        if (pass.returned_url) {
            passHtml += `<div class='mt-2'><a href="${pass.returned_url}" class="file-link" target="_blank">View Returned Pass</a></div>`;
            passHtml += `<div class='mt-2'>
                <button onclick="confirmSecurityPass(${pass.id})" class="btn btn-success btn-sm">Confirm</button>
                <button onclick="openRejectPassModal(${pass.id})" class="btn btn-danger btn-sm">Reject</button>
            </div>`;
        } else {
            passHtml += `<div class='mt-2'><em>Waiting for user to return filled pass...</em></div>`;
        }
        passHtml += `<div class='mt-2'><strong>Status:</strong> ${pass.status || 'Pending'}</div>`;
        if (pass.status === 'Rejected' && pass.rejection_reason) {
            passHtml += `<div class='alert alert-danger mt-2'><strong>Reason:</strong> ${pass.rejection_reason}</div>`;
        }
        passHtml += `</div>`;
    } else {
        // If payment is approved but no security pass uploaded, show upload form
        if (pass.status === 'Payment Approved' && !pass.file_url) {
            passHtml = `<form id="uploadPassForm" enctype="multipart/form-data" onsubmit="uploadSecurityPass(event)">
                <input type="file" name="security_pass" required>
                <button type="submit" class="btn btn-primary btn-sm">Upload Security Pass</button>
            </form>`;
        } else {
            passHtml = `<div class="pending-section">Waiting for security pass...</div>`;
        }
    }
    document.getElementById('passDetails').innerHTML = passHtml;
}

function uploadSecurityPass(event) {
    event.preventDefault();
    const reservationId = document.getElementById('current-reservation-id').value;
    const fileInput = event.target.querySelector('input[type="file"]');
    if (!fileInput.files[0]) {
        alert('Please select a file to upload');
        return;
    }
    const formData = new FormData();
    formData.append('security_pass', fileInput.files[0]);
    fetchWithToken(`/superuser_portal/reservation/${reservationId}/upload-security-pass/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Security pass uploaded successfully!');
            viewReservationDetails(reservationId);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while uploading the security pass. Please try again.');
    });
}

function confirmSecurityPass(reservationId) {
    if (!confirm('Confirm this returned security pass?')) return;
    fetchWithToken(`/superuser_portal/reservation/${reservationId}/confirm-security-pass/`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Security pass confirmed!');
            viewReservationDetails(reservationId);
            updateReservationRowStatus(reservationId, 'Completed');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred.');
    });
}

function openRejectPassModal(reservationId) {
    document.getElementById('reject-pass-reservation-id').value = reservationId;
    document.getElementById('reject-pass-reason').value = '';
    document.getElementById('rejectPassModal').style.display = 'block';
}
function closeRejectPassModal() {
    document.getElementById('rejectPassModal').style.display = 'none';
}
document.getElementById('rejectPassForm').onsubmit = function(e) {
    e.preventDefault();
    const reservationId = document.getElementById('reject-pass-reservation-id').value;
    const reason = document.getElementById('reject-pass-reason').value.trim();
    if (!reason) {
        alert('Please provide a reason.');
        return;
    }
    fetchWithToken(`/superuser_portal/reservation/${reservationId}/reject-security-pass/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `reason=${encodeURIComponent(reason)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Security pass rejected.');
            closeRejectPassModal();
            viewReservationDetails(reservationId);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred.');
    });
};

closeBtn.onclick = function() {
    modal.style.display = 'none';
}

window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// CSRF Token handling for Ajax requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add CSRF token to all fetch requests
function fetchWithToken(url, options = {}) {
    const csrfToken = getCookie('csrftoken');
    return fetch(url, {
        ...options,
        headers: {
            ...options.headers,
            'X-CSRFToken': csrfToken,
        },
    });
}

function uploadBilling(event) {
    event.preventDefault(); // Prevent default form submission

    const reservationId = document.getElementById('current-reservation-id').value;
    const fileInput = event.target.querySelector('input[type="file"]');

    if (!fileInput.files[0]) {
        alert('Please select a file to upload');
        return;
    }

    const formData = new FormData();
    formData.append('billing_statement', fileInput.files[0]);
    formData.append('reservation_id', reservationId);

    fetchWithToken(`/superuser_portal/upload_billing/${reservationId}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('Billing statement uploaded successfully!');
            updateBillingSection({
                statement_url: data.file_url
            });
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while uploading the billing statement. Please try again.');
    });
}
</script>
{% endblock %}

