{% extends 'superuser_portal/base_superuser.html' %}
{% load static %}

{% block title %}System Settings{% endblock %}

{% block extra_head %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
<style>
    .settings-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .section-header {
        margin-bottom: 20px;
    }
    
    .calendar-section {
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .blocked-dates-list {
        display: grid;
        gap: 15px;
    }
    
    .blocked-date-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .blocked-date-item:hover {
        transform: translateX(5px);
    }
    
    .blocked-date-info h4 {
        margin: 0 0 8px 0;
        color: #1a1a1a;
        font-size: 1.1em;
    }
    
    .date-range {
        color: #666;
        font-size: 0.9em;
    }
    
    .blocked-reason {
        margin-top: 8px;
        color: #666;
        font-style: italic;
    }
    
    .delete-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .delete-btn:hover {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    
    .modal-content {
        position: relative;
        background: white;
        margin: 8% auto;
        padding: 25px;
        width: 90%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .close {
        position: absolute;
        right: 20px;
        top: 15px;
        font-size: 24px;
        font-weight: 700;
        color: #666;
        cursor: pointer;
    }
    
    .close:hover {
        color: #333;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .save-btn {
        background: #0d6efd;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .save-btn:hover {
        background: #0056b3;
    }

    h3 {
        margin: 30px 0 20px 0;
        color: #333;
    }

    .detail-group {
        margin-bottom: 15px;
    }
    
    .detail-group label {
        font-weight: 600;
        color: #333;
        display: block;
        margin-bottom: 5px;
    }
    
    .detail-group p {
        margin: 0;
        color: #666;
        line-height: 1.4;
    }

    /* Add color coding for blocked dates in calendar */
    .blocked-date-event {
        background-color: #dc3545 !important;
        border-color: #dc3545 !important;
        color: white !important;
        cursor: pointer !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-section">
        <div class="section-header">
            <h2>Facility Date Blocking System</h2>
        </div>
        
        <!-- Calendar Section -->
        <div class="calendar-section">
            <div id="calendar"></div>
        </div>

        <!-- Active Blocked Dates -->
        <h3>Currently Blocked Dates</h3>
        <div class="blocked-dates-list">
            {% for blocked_date in blocked_dates %}
            <div class="blocked-date-item" onclick="showBlockedDateDetails({
                    id: '{{ blocked_date.id }}',
                    facility: {
                        name: '{{ blocked_date.facility.name }}'
                    },
                    start_date: '{{ blocked_date.start_date|date:"M d, Y" }}',
                    end_date: '{{ blocked_date.end_date|date:"M d, Y" }}',
                    start_time: '{{ blocked_date.start_time|time:"g:i A" }}',
                    end_time: '{{ blocked_date.end_time|time:"g:i A" }}',
                    reason: '{{ blocked_date.reason }}',
                    created_by: '{{ blocked_date.created_by }}',
                    created_at: '{{ blocked_date.created_at|date:"M d, Y g:i A" }}'
                })">
                <div class="blocked-date-info">
                    <h4>{{ blocked_date.facility.name }}</h4>
                    <div class="date-range">
                        <i class="far fa-calendar-alt"></i>
                        <span>{{ blocked_date.start_date|date:"M d, Y" }} {{ blocked_date.start_time|time:"g:i A" }} - 
                              {{ blocked_date.end_date|date:"M d, Y" }} {{ blocked_date.end_time|time:"g:i A" }}</span>
                    </div>
                    {% if blocked_date.reason %}
                    <p class="blocked-reason">{{ blocked_date.reason }}</p>
                    {% endif %}
                </div>
                <div class="blocked-date-actions">
                    <button onclick="handleDelete(event, '{{ blocked_date.id }}')" class="delete-btn" title="Delete blocked date">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <p>No dates are currently blocked</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Block Date Modal -->
<div id="blockDateModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Block Date</h2>
        <form id="blockDateForm" method="POST" action="{% url 'superuser_portal:manage_blocked_dates' %}">
            {% csrf_token %}
            <input type="hidden" id="selectedDate" name="start_date">
            <div class="form-group">
                <label for="facility">Select Facility:</label>
                <select id="facility" name="facility" required>
                    {% for facility in facilities %}
                        <option value="{{ facility.id }}">{{ facility.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="startTime">Start Time:</label>
                <input type="time" id="startTime" name="start_time" required>
            </div>
            <div class="form-group">
                <label for="endTime">End Time:</label>
                <input type="time" id="endTime" name="end_time" required>
            </div>
            <div class="form-group">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate" name="end_date" required>
            </div>
            <div class="form-group">
                <label for="blockReason">Reason:</label>
                <textarea id="blockReason" name="reason" required placeholder="Enter the reason for blocking this date"></textarea>
            </div>
            <button type="submit" class="save-btn">Block Date</button>
        </form>
    </div>
</div>

<!-- View Blocked Date Details Modal -->
<div id="viewBlockedDateModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Blocked Date Details</h2>
        <div class="blocked-date-details">
            <div class="detail-group">
                <label>Facility:</label>
                <p id="viewFacilityName"></p>
            </div>
            <div class="detail-group">
                <label>Date Range:</label>
                <p id="viewDateRange"></p>
            </div>
            <div class="detail-group">
                <label>Time:</label>
                <p id="viewTimeRange"></p>
            </div>
            <div class="detail-group">
                <label>Reason:</label>
                <p id="viewReason"></p>
            </div>
            <div class="detail-group">
                <label>Created By:</label>
                <p id="viewCreatedBy"></p>
            </div>
            <div class="detail-group">
                <label>Created At:</label>
                <p id="viewCreatedAt"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prevent event bubbling when deleting
    window.handleDelete = function(event, id) {
        event.stopPropagation();
        deleteBlockedDate(id);
    };

    // Initialize calendar
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth'
        },
        selectable: true,
        select: function(info) {
            showBlockDateModal(info.startStr);
        },
        eventClick: function(info) {
            // Extract the blocked date info from the event
            var blockedDate = {
                id: info.event.id,
                facility: {
                    name: info.event.title.split(' (')[0]
                },
                start_date: info.event.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                end_date: info.event.end ? info.event.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : info.event.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                start_time: info.event.start.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }),
                end_time: info.event.end ? info.event.end.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }) : '',
                reason: info.event.extendedProps.reason || 'Not specified',
                created_by: info.event.extendedProps.created_by || 'System',
                created_at: info.event.extendedProps.created_at || 'Not available'
            };
            showBlockedDateDetails(blockedDate);
        },
        events: [
            {% for blocked_date in blocked_dates %}
            {
                id: '{{ blocked_date.id }}',
                title: '{{ blocked_date.facility.name }} ({{ blocked_date.start_time|time:"g:i A" }} - {{ blocked_date.end_time|time:"g:i A" }})',
                start: '{{ blocked_date.start_date|date:"Y-m-d" }}T{{ blocked_date.start_time|time:"H:i:s" }}',
                end: '{{ blocked_date.end_date|date:"Y-m-d" }}T{{ blocked_date.end_time|time:"H:i:s" }}',
                allDay: false,
                className: 'blocked-date-event',
                extendedProps: {
                    reason: '{{ blocked_date.reason }}',
                    created_by: '{{ blocked_date.created_by }}',
                    created_at: '{{ blocked_date.created_at|date:"M d, Y g:i A" }}'
                }
            },
            {% endfor %}
        ],
        dateClick: function(info) {
            showBlockDateModal(info.dateStr);
        }
    });

    calendar.render();

    // Modal Management
    var blockModal = document.getElementById('blockDateModal');
    var viewModal = document.getElementById('viewBlockedDateModal');
    var selectedDateInput = document.getElementById('selectedDate');
    var endDateInput = document.getElementById('endDate');

    window.showBlockDateModal = function(dateStr) {
        selectedDateInput.value = dateStr;
        endDateInput.value = dateStr;
        endDateInput.min = dateStr;
        
        // Set default times
        var startTime = document.getElementById('startTime');
        var endTime = document.getElementById('endTime');
        if (!startTime.value) startTime.value = '08:00';
        if (!endTime.value) endTime.value = '17:00';
        
        blockModal.style.display = 'block';
    }

    // Close button handlers
    document.querySelectorAll('.modal .close').forEach(function(closeBtn) {
        closeBtn.onclick = function() {
            closeBtn.closest('.modal').style.display = 'none';
        }
    });

    // Click outside modal to close
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }

    // Time input validation
    document.getElementById('startTime').addEventListener('change', function() {
        var endTime = document.getElementById('endTime');
        endTime.min = this.value;
        if (endTime.value < this.value) {
            endTime.value = this.value;
        }
    });

    // End date validation
    document.getElementById('endDate').addEventListener('change', function() {
        if (this.value < selectedDateInput.value) {
            this.value = selectedDateInput.value;
        }
    });

    // Delete Blocked Date
    window.deleteBlockedDate = function(id) {
        if (confirm('Are you sure you want to delete this blocked date?')) {
            fetch('/superuser_portal/blocked-dates/' + id + '/delete/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Error deleting blocked date');
                }
            });
        }
    }

    // View Blocked Date Details
    window.showBlockedDateDetails = function(blockedDate) {
        document.getElementById('viewFacilityName').innerText = blockedDate.facility.name;
        document.getElementById('viewDateRange').innerText = blockedDate.start_date + ' - ' + blockedDate.end_date;
        document.getElementById('viewTimeRange').innerText = blockedDate.start_time + ' - ' + blockedDate.end_time;
        document.getElementById('viewReason').innerText = blockedDate.reason;
        document.getElementById('viewCreatedBy').innerText = blockedDate.created_by;
        document.getElementById('viewCreatedAt').innerText = blockedDate.created_at;

        viewModal.style.display = 'block';
    }
});
</script>
{% endblock %}

